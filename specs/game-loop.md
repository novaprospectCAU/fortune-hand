# Fortune's Hand - 게임 루프 상세

## 전체 게임 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                      GAME START                             │
│  • 덱 초기화 (52장 표준 덱)                                   │
│  • 시작 자원: Gold 100, Hands 4, Discards 3                 │
│  • 라운드 1 시작                                             │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    ROUND START                              │
│  • 목표 점수 설정 (라운드별 증가)                              │
│  • Hands/Discards 리셋                                      │
│  • 덱 셔플                                                   │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
          ┌───────────────────────────────────────┐
          │              TURN LOOP                │
          │         (Hands > 0 동안 반복)          │
          └───────────────────┬───────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. SLOT_PHASE                                               │
│    ┌───┬───┬───┐                                            │
│    │ ? │ ? │ ? │  → 자동 스핀                                │
│    └───┴───┴───┘                                            │
│    • SlotResult 생성                                         │
│    • 조커 효과 적용 (slot 트리거)                              │
│    • 즉시 보상 지급 (gold, chips)                             │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. DRAW_PHASE                                               │
│    • 기본 8장 드로우                                          │
│    • SlotResult.cardBonus.extraDraw 적용                    │
│    • SlotResult.penalty.discardCards 적용                   │
│    • 조커 효과 적용 (draw 트리거)                              │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. PLAY_PHASE                                               │
│    • 플레이어 카드 선택 (1-5장)                                │
│    • 선택지:                                                 │
│      - Play Hand: 선택한 카드로 핸드 플레이                    │
│      - Discard: 선택한 카드 버리고 새로 드로우 (제한 있음)       │
│    • 특수 카드 효과 발동 (triggerSlot, triggerRoulette)       │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. SCORE_PHASE                                              │
│    • 포커 핸드 판정                                           │
│    • 기본 점수 계산 (chips × mult)                            │
│    • 조커 효과 순차 적용                                       │
│    • 슬롯 보너스 적용 (scoreMultiplier)                       │
│    • ScoreCalculation 생성                                   │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. ROULETTE_PHASE                                           │
│    • 스킵 페널티 체크 (SlotResult.penalty.skipRoulette)       │
│    • 플레이어 선택:                                           │
│      - Spin: 배수 도전                                       │
│      - Skip: 현재 점수 그대로                                 │
│    • 스핀 시 RouletteResult에 따라 점수 조정                   │
│    • 0 당첨 시 해당 턴 점수 = 0                               │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. REWARD_PHASE                                             │
│    • 최종 점수를 currentScore에 누적                          │
│    • 골드 보상 (점수 기반)                                     │
│    • Hands 카운트 감소                                        │
│    • 목표 달성 체크                                           │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
                    ┌─────────────────┐
                    │ Hands > 0 ?     │
                    └────────┬────────┘
                      Yes ╱     ╲ No
                         ╱       ╲
            ┌───────────┘         └───────────┐
            ▼                                 ▼
    [TURN LOOP 반복]              ┌──────────────────────┐
                                  │ 목표 점수 달성?       │
                                  └──────────┬───────────┘
                                    Yes ╱     ╲ No
                                       ╱       ╲
                          ┌───────────┘         └───────────┐
                          ▼                                 ▼
┌─────────────────────────────────────────┐    ┌───────────────────┐
│ 7. SHOP_PHASE                           │    │    GAME OVER      │
│    • 상점 아이템 생성 (조커, 카드, 팩)     │    │  • 최종 라운드    │
│    • 구매 / 리롤 / 스킵                  │    │  • 최종 점수      │
│    • 다음 라운드로                       │    │  • 통계           │
└─────────────────────────────────────────┘    └───────────────────┘
```

## 점수 계산 공식

```
최종 점수 = (기본 Chips + 보너스 Chips) × (기본 Mult + 보너스 Mult) × 슬롯 배수 × 룰렛 배수
```

### 핸드 타입별 기본 값

| 핸드 | 기본 Chips | 기본 Mult |
|------|-----------|----------|
| High Card | 5 | 1 |
| Pair | 10 | 2 |
| Two Pair | 20 | 2 |
| Three of a Kind | 30 | 3 |
| Straight | 30 | 4 |
| Flush | 35 | 4 |
| Full House | 40 | 4 |
| Four of a Kind | 60 | 7 |
| Straight Flush | 100 | 8 |
| Royal Flush | 100 | 8 |

### 카드 칩 값

| 랭크 | Chips |
|------|-------|
| 2-10 | 숫자값 |
| J | 10 |
| Q | 10 |
| K | 10 |
| A | 11 |

## 라운드별 목표 점수

| 라운드 | 목표 점수 | 난이도 |
|--------|----------|--------|
| 1 | 300 | Tutorial |
| 2 | 800 | Easy |
| 3 | 2,000 | Easy |
| 4 | 5,000 | Medium |
| 5 | 11,000 | Medium |
| 6 | 20,000 | Hard |
| 7 | 35,000 | Hard |
| 8 | 50,000 | Expert |
| 9+ | +25,000/라운드 | Endless |

## 상태 전이 다이어그램

```
IDLE ──(startGame)──▶ SLOT_PHASE
                           │
                     (spinSlot)
                           ▼
                      DRAW_PHASE
                           │
                     (drawCards)
                           ▼
                      PLAY_PHASE
                        │    │
              (playHand)│    │(discard)
                        ▼    └──▶ DRAW_PHASE
                    SCORE_PHASE
                           │
                    (calculateScore)
                           ▼
                    ROULETTE_PHASE
                        │    │
               (spin)   │    │(skip)
                        ▼    ▼
                    REWARD_PHASE
                           │
              ┌────────────┴────────────┐
              │                         │
        (handsLeft)              (noHandsLeft)
              │                         │
              ▼                         ▼
         SLOT_PHASE              [목표 달성?]
                                   │    │
                              (yes)│    │(no)
                                   ▼    ▼
                             SHOP_PHASE  GAME_OVER
                                   │
                            (leaveShop)
                                   │
                                   ▼
                              SLOT_PHASE (다음 라운드)
```

## 이벤트 발생 시점

| Phase | 발생 이벤트 |
|-------|------------|
| SLOT_PHASE | `SLOT_SPIN` |
| DRAW_PHASE | `CARDS_DRAWN` |
| PLAY_PHASE | `CARDS_PLAYED` 또는 `CARDS_DISCARDED` |
| SCORE_PHASE | `SCORE_CALCULATED` |
| ROULETTE_PHASE | `ROULETTE_SPIN` (스핀한 경우) |
| REWARD_PHASE | `ROUND_END` (라운드 종료 시) |
| SHOP_PHASE | `ITEM_BOUGHT` (구매 시) |
| GAME_OVER | `GAME_OVER` |
